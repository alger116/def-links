<!DOCTYPE html>
<html lang="et">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Kaitse hangete portaalid</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ‚Ä¶ keep your existing styles ‚Ä¶ */
  </style>
</head>
<body>
  <h1>Kaitse hangete portaalid</h1>
  <div class="controls">
    <button id="btn-add-country">Lisa riik</button>
    <button id="btn-add-link">Lisa link</button>
  </div>

  <div id="loading">Laadin andmeid‚Ä¶</div>
  <div id="status" style="color: #ef4444; text-align:center;"></div>
  <div id="container"></div>

  <!-- Modal for adding/editing links -->
  <div id="modal" style="visibility:hidden; /* ‚Ä¶ your modal styles ‚Ä¶ */">
    <div class="box">
      <h2 id="modal-title">Lisa link</h2>
      <label>Riik</label>
      <select id="input-country"></select>
      <label>Nimi</label>
      <input id="input-name" type="text" />
      <label>URL</label>
      <input id="input-url" type="url" />
      <div class="actions">
        <button class="cancel">T√ºhista</button>
        <button class="save">Salvesta</button>
      </div>
    </div>
  </div>

  <script>
  // === CONFIGURE THESE ===
  const TOKEN = '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';
  const OWNER = 'alger116';
  const REPO  = 'def-links';
  const PATH  = 'db.json';
  // =======================

  let STATE = { data: {}, sha: null };
  const loading = document.getElementById('loading');
  const status  = document.getElementById('status');
  const container = document.getElementById('container');
  const modal   = document.getElementById('modal');
  const selCountry = document.getElementById('input-country');
  const inpName  = document.getElementById('input-name');
  const inpURL   = document.getElementById('input-url');
  const modalTitle = document.getElementById('modal-title');

  function authHeaders(m) {
    const h = { 'Accept':'application/vnd.github.v3+json' };
    if (m !== 'GET') {
      h['Authorization'] = `token ${TOKEN}`;
      h['Content-Type']  = 'application/json';
    }
    return h;
  }

  // Fetch raw JSON + SHA
  async function fetchData() {
    loading.style.display = '';
    status.textContent = '';
    try {
      const rawUrl = `https://raw.githubusercontent.com/${OWNER}/${REPO}/main/${PATH}`;
      const dRes = await fetch(rawUrl);
      if (!dRes.ok) throw new Error(`Andmeid ei saa laadida (${dRes.status})`);
      const data = await dRes.json();
      const apiUrl = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}`;
      const mRes = await fetch(apiUrl, { headers: authHeaders('GET') });
      if (!mRes.ok) throw new Error(`SHA ei saa laadida (${mRes.status})`);
      const { sha } = await mRes.json();
      STATE = { data, sha };
      renderGrid();
    } catch (e) {
      status.textContent = e.message;
    } finally {
      loading.style.display = 'none';
    }
  }

  // Commit back to GitHub
  async function updateData() {
    const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}`;
    const body = {
      message: 'Update links',
      content: btoa(JSON.stringify(STATE.data, null,2)),
      sha: STATE.sha
    };
    const res = await fetch(url, {
      method: 'PUT',
      headers: authHeaders('PUT'),
      body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error(`Salvestamine eba√µnnestus (${res.status})`);
    const { content } = await res.json();
    STATE.sha = content.sha;
  }

  // Render all countries & links
  function renderGrid() {
    container.innerHTML = '';
    const countries = Object.keys(STATE.data);
    if (!countries.length) {
      container.innerHTML = '<p style="text-align:center;color:#666">√úhtki riiki ega linki pole.</p>';
      return;
    }
    for (const country of countries) {
      const links = STATE.data[country];
      const card = document.createElement('div');
      card.className = 'card';
      const h2 = document.createElement('h2');
      h2.textContent = country + ' ';
      // delete whole country button
      const btnDelCountry = document.createElement('button');
      btnDelCountry.textContent = 'üóë';
      btnDelCountry.title = 'Kustuta riik ja k√µik lingid';
      btnDelCountry.onclick = async () => {
        if (!confirm(`Kustuta riik "${country}"?`)) return;
        delete STATE.data[country];
        await updateData();
        fetchData();
      };
      h2.appendChild(btnDelCountry);
      card.appendChild(h2);

      const ul = document.createElement('ul');
      for (let i = 0; i < links.length; i++) {
        const lnk = links[i];
        const li = document.createElement('li');
        const a  = document.createElement('a');
        a.href = lnk.url; a.target = '_blank'; a.textContent = lnk.name;
        // edit button
        const btnEdit = document.createElement('button');
        btnEdit.textContent = '‚úèÔ∏è';
        btnEdit.title = 'Muuda linki';
        btnEdit.onclick = () => openLinkModal(country, i);
        // delete button
        const btnX = document.createElement('button');
        btnX.textContent = '‚ùå';
        btnX.title = 'Kustuta link';
        btnX.onclick = async () => {
          if (!confirm(`Kustuta link "${lnk.name}"?`)) return;
          STATE.data[country].splice(i,1);
          await updateData();
          fetchData();
        };
        li.append(a, btnEdit, btnX);
        ul.appendChild(li);
      }
      card.appendChild(ul);
      container.appendChild(card);
    }
  }

  // ------------------- Modal Logic -------------------

  let editInfo = null;

  function openLinkModal(country, index=null) {
    // Populate country dropdown
    selCountry.innerHTML = Object.keys(STATE.data)
      .map(c => `<option${c===country?' selected':''}>${c}</option>`)
      .join('');
    if (index === null) {
      modalTitle.textContent = 'Lisa link';
      inpName.value = inpURL.value = '';
      editInfo = { country:null, index:null };
    } else {
      modalTitle.textContent = 'Muuda linki';
      const link = STATE.data[country][index];
      inpName.value = link.name;
      inpURL.value  = link.url;
      editInfo = { country, index };
    }
    modal.style.visibility = 'visible';
  }

  function closeModal() {
    modal.style.visibility = 'hidden';
    editInfo = null;
  }

  document.querySelector('#modal .cancel').onclick = closeModal;

  document.querySelector('#modal .save').onclick = async () => {
    const country = selCountry.value.trim();
    const name    = inpName.value.trim();
    const url     = inpURL.value.trim();
    if (!country||!name||!url) {
      return alert('T√§ida k√µik v√§ljad!');
    }
    // add new country if needed
    if (!STATE.data[country]) STATE.data[country] = [];
    if (editInfo.index === null) {
      // new link
      STATE.data[country].push({ name, url });
    } else {
      // update existing
      STATE.data[editInfo.country][editInfo.index] = { name, url };
    }
    try {
      await updateData();
      closeModal();
      fetchData();
    } catch (e) {
      alert(e.message);
    }
  };

  // Hook up controls
  document.getElementById('btn-add-country')
    .onclick = async () => {
      const name = prompt('Sisesta uue riigi nimi:').trim();
      if (!name) return;
      if (STATE.data[name]) {
        alert(`Riik "${name}" juba eksisteerib.`);
        return;
      }
      STATE.data[name] = [];
      try {
        await updateData();
        fetchData();
      } catch (e) {
        alert(`Riigi lisamine eba√µnnestus: ${e.message}`);
      }
    };

  document.getElementById('btn-add-link')
    .onclick = () => openLinkModal(null, null);

  // Initial load
  fetchData();
  </script>
</body>
</html>
